<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=0">
    <title>Drinkadink!</title>
    <link rel="author" href="https://plus.google.com/+SeanMcBeth/posts">
    <meta property="og:locale" content="en_US">
    <link type="text/css" rel="stylesheet" href="css/style.css">
    <link type="text/css" rel="stylesheet" href="css/bears.css">
    <style type="text/css">
        *{
            box-sizing: border-box;
        }
        .button{
            width:100%;
            margin-top:0.5em;
        }
        #display{
            position:absolute;
            top:0;
            bottom:0;
            left:0;
            right:0;
            text-align:center;
            background-color:#cfc;
        }
        ul{
            text-align:left;
        }
        #controls{
            position:absolute;
            bottom:0;
            left:1em;
            right:1em;
        }
        #slots{
            border:inset 3px #c0c0c0;
            background-color:white;
        }
        h1{
            font-family: serif;
            font-size: 50px;
            color:#0f0;
            -webkit-text-stroke: 2px #070;
            text-shadow: #030 3px 3px 3px;
        }
    </style>
</head>
<body>
    <section id="display">
        <h1>Shocktails!</h1>
        <div id="slots">
        </div>
        <ul id="output"></ul>
        <p id="controls">
            <a class="primary button" id="cocktail">Cocktail</a><br>
            <a class="primary button" id="mocktail">Mocktail</a>
        </p>
    </section>
    <script type="text/javascript" src="js/psychologist/core.js"></script>
    <script type="text/javascript" src="js/output/Audio3DOutput.js"></script>
    <script type="text/javascript" src="js/controllers/slots.js"></script>
    <script type="text/javascript">
        var audio = new Audio3DOutput();
        var ROWS = 4;
        var COLS = 4;
        var FRAMES_PER_SECOND = 16;
        var DT = 1000 / FRAMES_PER_SECOND;
        var TILES = ROWS * COLS;
        var SLOTS = 8;
        var SECONDS_PER_SLOT = 0.25;
        var SECONDS = SLOTS * SECONDS_PER_SLOT;
        var FRAMES = SECONDS * FRAMES_PER_SECOND;
        var FRAMES_PER_SLOT = FRAMES_PER_SECOND * SECONDS_PER_SLOT;
        var START_NOTE = 50;
        var ctrls = findEverything();
        var img = new Image();
        img.onload = start;
        img.src = "img/slots.jpg";
        function start(){
            var tileWidth = img.width / COLS;
            var tileHeight = img.height / ROWS;
            function i2xy(i){
                var x = i % COLS;
                var y = Math.floor(i / COLS);
                return fmt("$1px $2px", x * tileWidth, y * tileHeight);
            }
            var slots = [];
            for(var i = 0; i < SLOTS; ++i){
                var slot = document.createElement("div");
                slot.id = "slot" + i;
                ctrls[slot.id] = slot;
                slot.style.display = "inline-block";
                slot.style.backgroundImage = fmt("url($1)", img.src);
                slot.style.backgroundPosition = i2xy(i);
                slot.style.width = px(tileWidth);
                slot.style.height = px(tileHeight);
                slot.style.margin = "1em";
                ctrls.slots.appendChild(slot);
                slots.push(slot);
            }
            addFullScreenShim(ctrls.display);
            var currentFrame = 0;
            function spin(){                
                if(currentFrame < FRAMES){
                    if(currentFrame === 0){
                        ctrls.output.innerHTML = "";
                    }
                    setTimeout(spin.bind(this), DT);
                    ++currentFrame;
                    var n = currentFrame % FRAMES_PER_SLOT;
                    var s = Math.floor(currentFrame / FRAMES_PER_SLOT);
                    audio.sawtooth(START_NOTE - n + s + 2 * (s % 2) - 1, 1, DT / 1000);
                    for(var i = s; i < SLOTS; ++i){
                        var t = Math.floor(Math.random() * TILES);
                        slots[i].style.backgroundPosition = i2xy(t);
                    }
                }
                else{
                    currentFrame = 0;
                    getObject("drinks/" + this.id, function(drink){
                        drink.forEach(function(d){
                            var li = document.createElement("li");
                            li.appendChild(document.createTextNode(d));
                            ctrls.output.appendChild(li);
                        });
                    });
                }
            }
            ctrls.cocktail.onclick = spin;
            ctrls.mocktail.onclick = spin;
        }
        addFullScreenShim(ctrls.display);
    </script>
</body>
</html>
